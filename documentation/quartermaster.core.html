<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Quartermaster API Docs</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Quartermaster</span> </span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>quartermaster</span></div></div></li><li class="depth-2 branch"><a href="quartermaster.alpha.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>alpha</span></div></a></li><li class="depth-2 branch current"><a href="quartermaster.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><a href="quartermaster.error.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>error</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="quartermaster.core.html#var-*always-block-on-release*"><div class="inner"><span>*always-block-on-release*</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-acquiring"><div class="inner"><span>acquiring</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-all-handle-maps"><div class="inner"><span>all-handle-maps</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-all-resource-managers"><div class="inner"><span>all-resource-managers</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-auto-reinitiater"><div class="inner"><span>auto-reinitiater</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-auto-releaser"><div class="inner"><span>auto-releaser</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-defmanager"><div class="inner"><span>defmanager</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-ensure-initiated.21"><div class="inner"><span>ensure-initiated!</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-identify-resource-leaks"><div class="inner"><span>identify-resource-leaks</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-new-resource-id"><div class="inner"><span>new-resource-id</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-overriding"><div class="inner"><span>overriding</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-resource-manager"><div class="inner"><span>resource-manager</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-ResourceHandle"><div class="inner"><span>ResourceHandle</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-reinitiate"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>reinitiate</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-release"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>release</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-release-all"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>release-all</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-resource"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>resource</span></div></a></li><li class="depth-2"><a href="quartermaster.core.html#var-resource*"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>resource*</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-SharedResource"><div class="inner"><span>SharedResource</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-force-terminate"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>force-terminate</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-initiate"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>initiate</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-initiated.3F"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>initiated?</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-resource-id"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>resource-id</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-status*"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>status*</span></div></a></li><li class="depth-2"><a href="quartermaster.core.html#var-terminate"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>terminate</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-SharedResourceManager"><div class="inner"><span>SharedResourceManager</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-acquire"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>acquire</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-handle-map"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>handle-map</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-reacquire"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>reacquire</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-reinitiate*"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>reinitiate*</span></div></a></li><li class="depth-2 branch"><a href="quartermaster.core.html#var-release*"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>release*</span></div></a></li><li class="depth-2"><a href="quartermaster.core.html#var-release-all*"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>release-all*</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-status"><div class="inner"><span>status</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-terminated.3F"><div class="inner"><span>terminated?</span></div></a></li><li class="depth-1"><a href="quartermaster.core.html#var-testing-for-resource-leaks"><div class="inner"><span>testing-for-resource-leaks</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">quartermaster.core</h1><div class="doc"><div class="markdown"></div></div><div class="public anchor" id="var-*always-block-on-release*"><h3>*always-block-on-release*</h3><h4 class="dynamic">dynamic</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div></div><div class="public anchor" id="var-acquiring"><h3>acquiring</h3><h4 class="type">macro</h4><div class="usage"><code>(acquiring bindings &amp; body)</code></div><div class="doc"><div class="markdown"><p>A guarded-let (utils.control) that releases symbols whose inits resolve to a ResourceHandle, but only if an exception is thrown in the bindings block.</p></div></div></div><div class="public anchor" id="var-all-handle-maps"><h3>all-handle-maps</h3><div class="usage"><code>(all-handle-maps)</code></div><div class="doc"><div class="markdown"><p>Use to get a not-quite-consistent snapshot of the handle maps from every resource manager.</p></div></div></div><div class="public anchor" id="var-all-resource-managers"><h3>all-resource-managers</h3><div class="usage"></div><div class="doc"><div class="markdown"></div></div></div><div class="public anchor" id="var-auto-reinitiater"><h3>auto-reinitiater</h3><h4 class="type">macro</h4><div class="usage"><code>(auto-reinitiater user-id resource-description)</code><code>(auto-reinitiater resource-description)</code></div><div class="doc"><div class="markdown"><p>Can only be used within the context of defmanager. When a resource is constructed, it is sometimes desirable that the resource know how to reinitiate itself. This macro constructs a function of one argument (the resource itself), that will ask the resource-manager to reinitiate that resource without removing any acquired handles.</p>
<p>If the discrimination function employs the user-id, then you MUST pass in the user-id here. If and only if the determinating function ignores the user-id, you can freely use the single-arity version.</p></div></div></div><div class="public anchor" id="var-auto-releaser"><h3>auto-releaser</h3><h4 class="type">macro</h4><div class="usage"><code>(auto-releaser user-id resource-description)</code><code>(auto-releaser resource-description)</code></div><div class="doc"><div class="markdown"><p>Can only be used within the context of a construction function passed to defmanager. When a resource is constructed, it is sometimes desirable that the resource know how to release itself from all handles. This macro constructs a function of one argument (the resource itself), with an optional second argument (block-on-release?) that will call release-all* on the resource-manager.</p>
<p>If the discrimination function employs the user-id, then you MUST pass in the user-id here. If and only if the determinating function ignores the user-id, you can freely use the single-arity version.</p></div></div></div><div class="public anchor" id="var-defmanager"><h3>defmanager</h3><h4 class="type">macro</h4><div class="usage"><code>(defmanager mgr-name &amp; {:as options})</code></div><div class="doc"><div class="markdown"><p>Creates a new resource manager defined by the supplied :discriminator, :constructor, and (optionally) :terminator.</p>
<p>Defines and registers three metrics associated with this manager: <namespace>.<manager-name>.construction-timer  Times the actual construction of resources. For SharedResources, this includes  calling <code>initiate</code>. <namespace>.<manager-name>.termination-timer  Times the actual termination of resources. For SharedResources, this includes  calling <code>terminate</code>. <namespace>.<manager-name>.extant-counter  Tracks how many unique resources exist at any point in time.</manager-name></namespace></manager-name></namespace></manager-name></namespace></p></div></div></div><div class="public anchor" id="var-ensure-initiated.21"><h3>ensure-initiated!</h3><h4 class="type">macro</h4><div class="usage"><code>(ensure-initiated! resource message)</code><code>(ensure-initiated! resource message data)</code></div><div class="doc"><div class="markdown"><p>Raises a :shared-resource/terminated error if the resource is terminated!</p></div></div></div><div class="public anchor" id="var-identify-resource-leaks"><h3>identify-resource-leaks</h3><h4 class="type">macro</h4><div class="usage"><code>(identify-resource-leaks &amp; body)</code></div><div class="doc"><div class="markdown"></div></div></div><div class="public anchor" id="var-new-resource-id"><h3>new-resource-id</h3><div class="usage"><code>(new-resource-id)</code><code>(new-resource-id tag)</code></div><div class="doc"><div class="markdown"><p>Returns a unique identifier. Takes the form {:uuid UUID,  :tag tag} with the :tag key optional.</p></div></div></div><div class="public anchor" id="var-overriding"><h3>overriding</h3><h4 class="type">macro</h4><div class="usage"><code>(overriding manager-&gt;overrides &amp; body)</code></div><div class="doc"><div class="markdown"><p>Allows temporary redefinition of one or more resource-manager’s parameters  (:discriminator, :constructor, :terminator). Especially useful in tests.</p>
<p>(overriding [manager {&amp; options}  manager {&amp; options}  …]  &amp; body)</p></div></div></div><div class="public anchor" id="var-resource-manager"><h3>resource-manager</h3><div class="usage"><code>(resource-manager rm-id discriminate constructor)</code><code>(resource-manager rm-id discriminate constructor terminator)</code></div><div class="doc"><div class="markdown"><p>rm-id - used for logging and debugging  discriminate - var containing function of &lt;user-id, resource-description&gt; -&gt; unique identifier for resource  constructor - var containing function of &lt;unique-identifier, resource-description&gt; -&gt; new resource  terminator - (optional) var containing function that the resource-manager will always call on the resource at termination.</p>
<p>Defines and registers three metrics associated with this manager: <namespace>.<manager-name>.construction-timer  Times the actual construction of resources. For SharedResources, this includes  calling <code>initiate</code>. <namespace>.<manager-name>.termination-timer  Times the actual termination of resources. For SharedResources, this includes  calling <code>terminate</code>. <namespace>.<manager-name>.extant-counter  Tracks how many unique resources exist at any point in time.</manager-name></namespace></manager-name></namespace></manager-name></namespace></p>
<p>defmanager is preferred outside of testing.</p></div></div></div><div class="public anchor" id="var-ResourceHandle"><h3>ResourceHandle</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-reinitiate"><h3>reinitiate</h3><div class="usage"><code>(reinitiate handle)</code><code>(reinitiate handle target-resource-id)</code></div><div class="doc"><div class="markdown"><p>If this resource handle is still valid, this attempts to force-terminate the resource and all its own resource, then reinitiate a new one, swapping the new resource for the old in the resource manager.</p>
<p>Any user-ids registered as having handlers on the old resource will still be registered as having handlers on the new resource, and the new resource will be accessible through all the old ResourceHandles.</p>
<p>If the resource implements SharedResource, then the target-resource-id is required; the reinitiation only takes effect if the target-resource-id matches the resource id of the resource in the manager. target-resource-id should be left off if the resource does not implement SharedResource.</p>
<p>Returns this ResourceHandle upon completion. If an exception is encountered this may raise a :quartermaster/reinitiate-error error.</p></div></div></div><div class="public anchor" id="var-release"><h3>release</h3><div class="usage"><code>(release handle)</code><code>(release handle block-on-release?)</code></div><div class="doc"><div class="markdown"><p>Informs the manager that the user-id associated with this handle no longer wishes to maintain its handle on the resource, exactly as if the user called SharedResourceManager/release*. ResourceHandles are expected to hold only WeakReferences to the resource s.t. leaking a ResourceHandle does not prevent GC of the resource itself once the manager has dropped it.</p>
<p>Returns true upon completion. If :quartermaster/terminate-error is raised, this will attempt to log a warning.</p></div></div></div><div class="public anchor" id="var-release-all"><h3>release-all</h3><div class="usage"><code>(release-all handle target-resource-id)</code><code>(release-all handle target-resource-id block-on-release?)</code></div><div class="doc"><div class="markdown"><p>Informs the manager that the user-id associated with this handle wishes to release <em>all</em> handles to this resource by <em>all</em> users, then to terminate the resource. ONLY TAKES EFFECT IF target-resource-id MATCHES THE RESOURCE KNOWN TO THE MANAGER. Use with caution.</p>
<p>If the resource does not implement SharedResource, nil may be passed as target-resource-id.</p>
<p>Returns true upon completion. If :quartermaster/terminate-error is raised, this will attempt to log a warning.</p></div></div></div><div class="public anchor" id="var-resource"><h3>resource</h3><div class="usage"><code>(resource handle)</code></div><div class="doc"><div class="markdown"><p>Returns the resource. Potentially repairs the resource. Use this or deref for cases that don’t involve registered <code>on-acquisition</code> functions. This, and deref, should never be called inside a registerd <code>on-acquisition</code> function.</p></div></div></div><div class="public anchor" id="var-resource*"><h3>resource*</h3><div class="usage"><code>(resource* handle)</code></div><div class="doc"><div class="markdown"><p>Returns the resource. Makes no attempt to check health or make repairs. Use this inside registered <code>on-acquisition</code> functions.</p></div></div></div></div></div></div><div class="public anchor" id="var-SharedResource"><h3>SharedResource</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-force-terminate"><h3>force-terminate</h3><div class="usage"><code>(force-terminate _)</code></div><div class="doc"><div class="markdown"><p>Used by resource managers when reinitiating a resource. The shared resource that has already been terminated will do nothing. Otherwise, it is expected to force-terminate all its own resources before terminating itself. Idempotent.</p></div></div></div><div class="public anchor" id="var-initiate"><h3>initiate</h3><div class="usage"><code>(initiate _)</code></div><div class="doc"><div class="markdown"><p>If not initiated, puts this resource into a usable state by generating a unique resource-id and acquiring any resources it requires (threads, channels, SharedResources, etc.). Returns an updated version of this resource. Calling initiate on a ResourceReference behaves as though calling initiate on the resource itself. Idempotent. May raise an error with type :quartermaster/initiate-error.</p></div></div></div><div class="public anchor" id="var-initiated.3F"><h3>initiated?</h3><div class="usage"><code>(initiated? _)</code></div><div class="doc"><div class="markdown"><p>Has this resource been initiated?</p></div></div></div><div class="public anchor" id="var-resource-id"><h3>resource-id</h3><div class="usage"><code>(resource-id _)</code></div><div class="doc"><div class="markdown"><p>Returns this resource’s unique resource-id if initiated; nil if terminated.</p></div></div></div><div class="public anchor" id="var-status*"><h3>status*</h3><div class="usage"><code>(status* _)</code></div><div class="doc"><div class="markdown"><p>Returns a (possibly empty) map of resource-specific status information.</p></div></div></div><div class="public anchor" id="var-terminate"><h3>terminate</h3><div class="usage"><code>(terminate _)</code></div><div class="doc"><div class="markdown"><p>Used to tell this resource to release all resources it required and to clean itself up, putting itself into an unusable state. Attempting to use a terminated resource may result in a :quartermaster/resource-terminated error being raised. Idempotent.</p></div></div></div></div></div></div><div class="public anchor" id="var-SharedResourceManager"><h3>SharedResourceManager</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-acquire"><h3>acquire</h3><div class="usage"><code>(acquire rm user-id description)</code><code>(acquire rm user-id description on-acquisition)</code></div><div class="doc"><div class="markdown"><p>Attempts to acquire the resource uniquely determined by description. Returns a ResourceReference on success. May raise various :quartermaster/* errors correponding to the management/lifecycle stage in which exceptions were encountered.</p>
<p>The mapping from description to unique resource is determined by means of the equivalence class indicated by a discriminator passed to the resource manager’s constructor.</p>
<p>If an appropriate resource does not exist already, it will be created by passing description to the construction function passed to the resource manager’s constructor. If the constructed resource implements SharedResource, it will be initiated before being cached by the manager.</p>
<p>Either way, this method will ensure that user-id is registered as having a handle on the resource. The resource will be evicted from the cache when the last user-id has released the resource. If it is a SharedResource, it will be terminated as well.</p>
<p>Calling <code>acquire</code> a second time with the same arguments should merely ensure that the resource, if SharedResource, is initiated, then return a new handle object without any additional side effects.</p>
<p>Some users require that certain side-effects be executed the first time the resource is created and any time it is dynamically swapped out by the resource manager for any reason. If this is the case, an optional on-acquisition argument may be passed. It is expected to be a function of one argument, a ResourceReference, which executes the side effects. The returned ResourceReference will ensure that this function is called appropriately.</p></div></div></div><div class="public anchor" id="var-handle-map"><h3>handle-map</h3><div class="usage"><code>(handle-map rm)</code></div><div class="doc"><div class="markdown"><p>Returns a snapshot {equivalence-class –&gt; #{&amp; user-ids}} for the resource-manager.</p></div></div></div><div class="public anchor" id="var-reacquire"><h3>reacquire</h3><div class="usage"><code>(reacquire rm user-id description)</code></div><div class="doc"><div class="markdown"><p>Attempts to fetch a resource already acquired. Useful if that resource instance was terminated for any reason. If user-id doesn’t already have a handle on it, then this throws an exception. Mainly used by ResourceReference.</p>
<p>DOES NOT RETURN A ResourceReference. Returns the resource itself.</p></div></div></div><div class="public anchor" id="var-reinitiate*"><h3>reinitiate*</h3><div class="usage"><code>(reinitiate* rm user-id description)</code><code>(reinitiate* rm user-id description resource-id)</code><code>(reinitiate* rm user-id description resource-id on-acquisition)</code></div><div class="doc"><div class="markdown"><p>If there is a resource determined by description being managed by this manager, this method will attempt to destroy the old resource and replace it with a new one, BUT ONLY IF THAT RESOURCE’S ID IS resource-id.</p>
<p>All user-ids registered as having handlers on the old resource will still be registered as having handlers on the replacement resource. Any ResourceReference that pointed to the old resource will now point to the new resource.</p>
<p>The old resource is destroyed by means of <code>force-terminate</code>. It is expected that the old resource will transitively call <code>force-terminate</code> on all its own resources.</p>
<p>Forcibly terminated resources are expected to raise a :shared-resource/terminated error, so that users may know to retry or to attempt to reinitiate resources.</p>
<p>DOES NOT RETURN A ResourceReference. Returns the resource itself. Mainly intended for use by ResourceHandle/reinitiate.</p></div></div></div><div class="public anchor" id="var-release*"><h3>release*</h3><div class="usage"><code>(release* rm user-id description)</code><code>(release* rm user-id description block-on-release?)</code></div><div class="doc"><div class="markdown"><p>Informs the manager that user-id no longer wishes to maintain its handle on the resource determined by description.</p>
<p>If user-id has the last handle on the resource, all references to the resource are dropped by the resource manager.</p>
<p>If a dropped resource implements SharedResource, it is terminated when it is dropped. By default, this occurs asynchronously; if block-on-release? is true, release will not return until the resource has been terminated. If the only other references to the resource are ResourceReferences, the resource may be garbage-collected.</p>
<p>Returns true. May raise a :quartermaster/terminate-error error. Mainly intended for internal use by ResourceHandle/release.</p></div></div></div><div class="public anchor" id="var-release-all*"><h3>release-all*</h3><div class="usage"><code>(release-all* rm user-id description target-resource-id)</code><code>(release-all* rm user-id description target-resource-id block-on-release?)</code></div><div class="doc"><div class="markdown"><p>If there is a resource determined by description being managed by this manager, this method will attempt atomically to release <em>all</em> handles to this resource and then terminate the resource – BUT ONLY IF THAT RESOURCE’S ID IS resource-id. Use with caution. If the manager’s discriminator function depends at all on user-id, then user-id must be correspond to that used at the resource’s acquisition. In all other cases, its value is irrelevant.</p>
<p>Returns true. May raise a :quartermaster/terminate-error error. Mainly intended for use by ResourceReference/release-all.</p></div></div></div></div></div></div><div class="public anchor" id="var-status"><h3>status</h3><div class="usage"><code>(status resource)</code></div><div class="doc"><div class="markdown"><p>Returns the resource’s status map, with the following keys merged in:</p>
<p>#{:quartermaster/initiated?}</p></div></div></div><div class="public anchor" id="var-terminated.3F"><h3>terminated?</h3><div class="usage"><code>(terminated? resource)</code></div><div class="doc"><div class="markdown"><p>Is it in a terminated state?</p></div></div></div><div class="public anchor" id="var-testing-for-resource-leaks"><h3>testing-for-resource-leaks</h3><h4 class="type">macro</h4><div class="usage"><code>(testing-for-resource-leaks &amp; body)</code></div><div class="doc"><div class="markdown"><p>For use in clojure.test tests. Tests that any resources acquired in the body are also released in the body. Binds <em>always-block-on-release</em> to true during the execution of body.</p></div></div></div></div></body></html>